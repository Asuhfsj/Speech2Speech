<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recorder</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <h1>Voice Recorder & Playback</h1>
    
    <div class="container">
        <div class="recorder-container">
            <h2>Record Your Voice</h2>
            <div class="status" id="recordingStatus">Click "Start Recording" to begin</div>
            <div id="recordingIndicator" style="display: none;">
                <span class="recording-indicator"></span>
                <span>Recording...</span>
                <div class="timer" id="recordingTimer">00:00</div>
            </div>
            <button id="startRecording">Start Recording</button>
            <button id="stopRecording" disabled>Stop Recording</button>
        </div>

        <div class="playback-container">
            <h2>Playback</h2>
            <div class="status" id="playbackStatus">No recording available</div>
            <audio id="audioPlayback" controls style="width: 100%; display: none;"></audio>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let mediaRecorder;
            let audioChunks = [];
            let recordingStartTime;
            let timerInterval;
            const startButton = document.getElementById('startRecording');
            const stopButton = document.getElementById('stopRecording');
            const recordingStatus = document.getElementById('recordingStatus');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const recordingTimer = document.getElementById('recordingTimer');
            const playbackStatus = document.getElementById('playbackStatus');
            const audioPlayback = document.getElementById('audioPlayback');

            function updateTimer() {
                const elapsed = new Date() - recordingStartTime;
                const seconds = Math.floor((elapsed / 1000) % 60).toString().padStart(2, '0');
                const minutes = Math.floor((elapsed / 1000 / 60) % 60).toString().padStart(2, '0');
                recordingTimer.textContent = `${minutes}:${seconds}`;
            }

            startButton.addEventListener('click', function() {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        startButton.disabled = true;
                        stopButton.disabled = false;
                        
                        recordingStatus.textContent = 'Recording...';
                        recordingIndicator.style.display = 'block';
                        audioPlayback.style.display = 'none';
                        playbackStatus.textContent = 'Recording in progress...';
                        
                        recordingStartTime = new Date();
                        timerInterval = setInterval(updateTimer, 1000);
                        updateTimer();
                        
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.start();
                    })
                    .catch(error => {
                        console.error('Error accessing microphone:', error);
                        recordingStatus.textContent = 'Error accessing microphone: ' + error.message;
                    });
            });

            // Stop recording and send the audio to the server
            stopButton.addEventListener('click', function() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    clearInterval(timerInterval);
                    
                    recordingIndicator.style.display = 'none';
                    recordingStatus.textContent = 'Recording stopped. Processing...';
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    
                    mediaRecorder.onstop = () => {
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.ogg');

                        recordingStatus.textContent = 'Uploading recording...';
                        fetch('/upload-audio', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                recordingStatus.textContent = 'Recording uploaded successfully!';
                                playbackStatus.textContent = 'Loading audio for playback...';
                                
                                // Set up audio playback
                                const audioUrl = `/get-audio/${data.filename}`;
                                audioPlayback.src = audioUrl;
                                audioPlayback.style.display = 'block';
                                playbackStatus.textContent = 'Audio ready for playback:';
                            } else {
                                recordingStatus.textContent = 'Error: ' + data.message;
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading audio:', error);
                            recordingStatus.textContent = 'Error uploading: ' + error.message;
                        });
                    };
                }
            });
        });
    </script>
</body>
</html>
